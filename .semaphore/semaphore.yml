version: v1.0
name: First pipeline example
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Build"
    task:
      prologue: &prologue
        commands:
          - checkout
          - export SEMAPHORE_GIT_TAG=`git tag -l --points-at $SEMAPHORE_GIT_SHA`
          - export SEMAPHORE_GIT_MSG=`git log -1 --pretty=%B`
      jobs:
      - name: Build
        commands:
          - echo SEMAPHORE_GIT_TAG=$SEMAPHORE_GIT_TAG SEMAPHORE_GIT_MSG=$SEMAPHORE_GIT_MSG
          - sem-version python 3.7
          - sem-version ruby 2.5.1
          - sem-version node 8.12.0

          - cache restore ruby
          - gem install bundler && gem update bundler && bundle config && bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
          - cache store ruby vendor/bundle

          - cd && cache restore pip && cd -
          - pip install -r requirements.txt
          - cd && cache store pip .pip_download_cache && cd -

          - cache restore node-$SEMAPHORE_GIT_BRANCH
          - npm install
          - cache store node-$SEMAPHORE_GIT_BRANCH node_modules

          - npm run build
          - cache store xpi-$SEMAPHORE_PIPELINE_ID xpi

  - name: Test
    task:
      prologue: *prologue
      jobs:
      - name: Zotero cluster 1
        env_vars:
          - name: ZOTERO
            value: zotero
          - name: CLUSTER
            value: "@test-cluster-1"
        commands: &commands
          - echo SEMAPHORE_GIT_TAG=$SEMAPHORE_GIT_TAG SEMAPHORE_GIT_MSG=$SEMAPHORE_GIT_MSG
          - cache restore ruby
          - cache restore xpi-$SEMAPHORE_PIPELINE_ID
          - git submodule sync && git submodule update --init --recursive

          - curl --silent --location https://github.com/retorquere/zotero-deb/releases/download/apt-get/install.sh | sudo bash
          - sudo apt-get update -o Dir::Etc::sourcelist="sources.list.d/zotero.list" -o Dir::Etc::sourceparts="-" -o APT::Get::List-Cleanup="0"
          - sudo apt-get install zotero jurism
          - ./check-latest-zotero.py


          - |
            if [[ "$SEMAPHORE_COMMIT_MESSAGE" == *"#trace"* ]]; then
              export TRACE=true
            fi

            if [[ "$SEMAPHORE_TRIGGER_SOURCE" = "scheduler" ]] || [[ ! -z "$SEMAPHORE_TAG" ]] || [[ "$SEMAPHORE_COMMIT_MESSAGE" == *"#nightly"* ]]; then
              export NIGHTLY=""
              export TRACE=true
            else
              export NIGHTLY="and not @nightly"
            fi

            bundle exec cucumber --format pretty --strict --tags "$CLUSTER $NIGHTLY"

      - name: Zotero not cluster 1
        env_vars:
          - name: ZOTERO
            value: zotero
          - name: CLUSTER
            value: "not @test-cluster-1"
        commands: *commands

      - name: Juris-M cluster 1
        env_vars:
          - name: ZOTERO
            value: jurism
          - name: CLUSTER
            value: "@test-cluster-1"
        commands: *commands

      - name: Juris-M not cluster 1
        env_vars:
          - name: ZOTERO
            value: jurism
          - name: CLUSTER
            value: "not @test-cluster-1"
        commands: *commands

  - name: Publish
    task:
      prologue: *prologue
      jobs:
      - name: Publish
        commands:
          - cache restore xpi-$SEMAPHORE_PIPELINE_ID
          - npm run release
      epilogue:
        commands:
          - cache delete xpi-$SEMAPHORE_PIPELINE_ID
