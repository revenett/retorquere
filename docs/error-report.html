<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
  <head>
    <meta charset="utf-8">
    <title>Upload</title>
  </head>
  <script>
    const bucket = 'https://better-bibtex-error-reports-62200312-euc.s3-eu-central-1.amazonaws.com/'

    function progress(text, id) {
      const progress = document.getElementById('progress')
      let li = null
      if (!id || !(li = document.getElementById(id))) {
        li = document.createElement('li')
        if (id) li.setAttribute('id', id)
        progress.appendChild(li)
      }
      li.innerText = text
    }

    function readFile(file) {
      return new Promise((resolve, reject) => {
        var fr = new FileReader()

        fr.onload = function() {
          resolve(fr.result)
        }

        if (file.type.startsWith('text/')) {
          fr.readAsText(file)
        } else {
          fr.readAsBinaryString(file)
        }
      })
    }

    function sendFile(name, type, data) {
      return new Promise(function (resolve, reject) {
        const xhr = new XMLHttpRequest()
        xhr.open('PUT', bucket + name)
        xhr.setRequestHeader('x-amz-storage-class', 'STANDARD')
        xhr.setRequestHeader('x-amz-acl', 'bucket-owner-full-control')
        xhr.setRequestHeader('Content-Type', type)

        xhr.onload = function () {
          if (this.status >= 200 && this.status < 300) {
            resolve(xhr.response)
          } else {
            reject({
              status: this.status,
              statusText: xhr.statusText
            })
          }
        }

        xhr.onerror = function () {
          reject({
            status: this.status,
            statusText: xhr.statusText
          })
        }
        xhr.send(data)
      })
    }

    async function _upload() {
      const guid = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
      const files = document.getElementById('files')
      for (const file of files.files) {
        const id = `_${file.name}`
        const target = guid + '-' + file.name
        progress(`Reading ${file.name}...`, id)
        const data = await readFile(file)
        progress(`Sending ${target}...`, id)
        await sendFile(target, file.type, data)
        progress(`Sent ${target}`, id)
      }
    }

    function upload() {
      _upload().catch(function(err) {
        console.log(err.status, err.statusText)
        if (err.message) {
          err = err.message
        } else if (err.status) {
          err = `${err.status}: ${err.statusText}`
        } else if (('' + err) === '[object Object]') {
          err = Object.keys(err).join(' / ')
        } else {
          err = '' + err
        }
        progress(err)
      })
      return false
    }
  </script>
  <body>
    <form method="POST" enctype="multipart/form-data" onsubmit="return upload()">
      <input type="file" id="files" name="files[]" multiple />
      <input type="submit" name="submit" value="Send"/>
      <ul id="progress"/>
    </form>
  </body>
</html>
